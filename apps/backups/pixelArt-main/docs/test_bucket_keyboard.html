<!DOCTYPE html>
<html>
<head>
    <title>Test Bucket Tool Keyboard Shortcut</title>
    <script src="js/config.js"></script>
    <script src="js/state.js"></script>
    <script src="js/dom.js"></script>
    <script src="js/canvas-manager.js"></script>
    <script src="js/tool-manager.js"></script>
    <script src="js/input-handler.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .test-step {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-result {
            font-weight: bold;
            color: green;
        }
        .test-fail {
            font-weight: bold;
            color: red;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #testCanvas {
            border: 1px solid #ccc;
            margin: 10px 0;
            background-color: white;
        }
        .canvas-container {
            position: relative;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Bucket Tool Keyboard Shortcut Test</h1>
        <p>This test verifies that the bucket tool works correctly when selected via keyboard shortcut.</p>

        <div class="test-step">
            <h3>Test Canvas Setup</h3>
            <div class="canvas-container">
                <canvas id="testCanvas" width="200" height="200"></canvas>
            </div>
            <button onclick="setupTestCanvas()">Setup Test Canvas</button>
            <div id="setup-result"></div>
        </div>

        <div class="test-step">
            <h3>Test 1: Bucket tool via keyboard shortcut</h3>
            <button onclick="testBucketKeyboardShortcut()">Test Bucket Shortcut (F)</button>
            <div id="test1-result"></div>
        </div>

        <div class="test-step">
            <h3>Test 2: Multiple bucket operations</h3>
            <button onclick="testMultipleBucketOperations()">Test Multiple Fills</button>
            <div id="test2-result"></div>
        </div>

        <script>
            // Mock UI objects
            window.UI = {
                drawingArea: document.getElementById('testCanvas'),
                toolBtns: [],
                colorPicker: {
                    value: '#FF0000'
                },
                colorHex: {
                    textContent: '#FF0000'
                },
                opacitySlider: {
                    value: '1.00'
                },
                compositionCanvas: document.getElementById('testCanvas')
            };

            // Mock CanvasManager
            window.CanvasManager = {
                render: function() {
                    console.log('CanvasManager.render() called');
                },
                saveLayerChange: function() {
                    console.log('CanvasManager.saveLayerChange() called');
                }
            };

            // Initialize state
            State.width = 200;
            State.height = 200;
            State.color = '#FF0000';
            State.opacity = 1.0;
            State.tool = 'pencil';

            function setupTestCanvas() {
                const canvas = document.getElementById('testCanvas');
                const ctx = canvas.getContext('2d');

                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw a pattern to test filling
                ctx.fillStyle = '#000000';
                ctx.fillRect(50, 50, 100, 100);

                // Draw some obstacles
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(70, 70, 20, 20);
                ctx.fillRect(120, 120, 20, 20);

                console.log('Test canvas setup complete with black square and white obstacles');
                document.getElementById('setup-result').innerHTML = '<span class="test-result">✓ Canvas setup complete</span>';

                // Initialize a layer for the tool manager
                State.frames = [{
                    layers: [{
                        name: 'Test Layer',
                        visible: true,
                        data: ctx.getImageData(0, 0, canvas.width, canvas.height)
                    }]
                }];
                State.currentFrameIndex = 0;
                State.activeLayerIndex = 0;

                return ctx;
            }

            function testBucketKeyboardShortcut() {
                setupTestCanvas();

                // Reset state
                State.tool = 'pencil';
                State.color = '#FF0000';
                State.opacity = 1.0;

                console.log('Before bucket shortcut:', 'Tool =', State.tool);

                // Simulate pressing 'F' key
                const keyboardEvent = new KeyboardEvent('keydown', {
                    key: 'f',
                    cancelable: true
                });

                // Mock mouse position at center of black square
                InputHandler.getMousePosition = function() {
                    return { x: 100, y: 100 };
                };

                // Call the keyboard handler
                InputHandler.onKeyDown(keyboardEvent);

                console.log('After bucket shortcut:', 'Tool =', State.tool);

                // Check if tool was changed to bucket
                const resultDiv = document.getElementById('test1-result');
                if (State.tool === 'bucket') {
                    resultDiv.innerHTML = '<span class="test-result">✓ PASS: Tool correctly changed to bucket</span>';

                    // Check if flood fill was executed by examining a pixel that should be filled
                    const canvas = document.getElementById('testCanvas');
                    const ctx = canvas.getContext('2d');
                    const pixelData = ctx.getImageData(100, 100, 1, 1).data;

                    // The pixel should be red (#FF0000) if fill worked
                    if (pixelData[0] === 255 && pixelData[1] === 0 && pixelData[2] === 0) {
                        resultDiv.innerHTML += '<br><span class="test-result">✓ PASS: Flood fill executed correctly</span>';
                    } else {
                        resultDiv.innerHTML += `<br><span class="test-fail">✗ FAIL: Flood fill not executed (RGB: ${pixelData[0]},${pixelData[1]},${pixelData[2]})</span>`;
                    }
                } else {
                    resultDiv.innerHTML = '<span class="test-fail">✗ FAIL: Tool not changed to bucket</span>';
                }
            }

            function testMultipleBucketOperations() {
                setupTestCanvas();

                // Test multiple fill operations
                const colors = ['#FF0000', '#00FF00', '#0000FF'];
                let allPassed = true;

                for (let i = 0; i < colors.length; i++) {
                    State.color = colors[i];
                    State.tool = 'pencil';

                    // Mock mouse position
                    InputHandler.getMousePosition = function() {
                        return { x: 100, y: 100 };
                    };

                    // Simulate bucket tool selection
                    const keyboardEvent = new KeyboardEvent('keydown', {
                        key: 'f',
                        cancelable: true
                    });
                    InputHandler.onKeyDown(keyboardEvent);

                    // Check if fill was applied
                    const canvas = document.getElementById('testCanvas');
                    const ctx = canvas.getContext('2d');
                    const pixelData = ctx.getImageData(100, 100, 1, 1).data;

                    const expectedR = parseInt(colors[i].slice(1, 3), 16);
                    const expectedG = parseInt(colors[i].slice(3, 5), 16);
                    const expectedB = parseInt(colors[i].slice(5, 7), 16);

                    if (!(pixelData[0] === expectedR && pixelData[1] === expectedG && pixelData[2] === expectedB)) {
                        allPassed = false;
                        break;
                    }
                }

                const resultDiv = document.getElementById('test2-result');
                if (allPassed) {
                    resultDiv.innerHTML = '<span class="test-result">✓ PASS: Multiple bucket operations work correctly</span>';
                } else {
                    resultDiv.innerHTML = '<span class="test-fail">✗ FAIL: Multiple bucket operations failed</span>';
                }
            }
        </script>
    </div>
</body>
</html>